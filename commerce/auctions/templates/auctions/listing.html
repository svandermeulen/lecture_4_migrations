{% extends "auctions/layout.html" %}

{% block title %}
    {{ listing.title }}
{% endblock %}

{% block body %}

    {% if not listing.active %}
        <h2>Listing: {{ listing.title }}</h2>
        <span class="badge badge-pill badge-secondary">Closed</span>
    {% else %}
        <h2>Listing: {{ listing.title }}</h2>
    {% endif %}
    <p><img src="{{ listing.image_url }}" alt="No image url provided" id="img_enlarged"></p>
    <p id="description">{{ listing.description }}</p>
    <br>
    <p id="starting_bid">Starting bid: ${{ listing.starting_bid }}</p>

    {% if listing.active %}
        {% if listing.get_bid_count > 0 %}
            <p class="price_listing">Latest bid: ${{ listing.current_price }}</p>
        {% endif %}

        <p id="bid_count">
            {{ listing.get_bid_count }} bid(s) so far.
            {% if listing.get_latest_bid.user.username == user.username %}
                Your bid is the current bid.
            {% endif %}
        </p>

        {% if user.username != listing.user.username %}
            <form action="{% url 'auctions:bid' listing.id %}" method="post">
                {% csrf_token %}
                {% for field in form %}
                    <div class="fieldWrapper">
                        {{ field.errors }}
                        {{ field }}
                    </div>
                {% endfor %}
                <input type="submit" class="btn btn-primary" title="Bid" value="Place Bid">
            </form>
        {% endif %}
    {% else %}
        {% if listing.get_latest_bid.user.username == user.username %}
            <p class="price_listing">You have won the auction with a bid of: ${{ listing.current_price }}</p>
            {% else %}
            <p>This auction is closed at a price of: ${{ listing.current_price }}</p>
        {% endif %}
    {% endif %}

    <hr>
    <h4>Details:</h4>
    <ul>
        <li>Listed by: {{ listing.user.username }}</li>
        <li>Listed on: {{ listing.date_creation|date:'D, M Y H:i:s'|title }}</li>
        <li>Latest bid on: {{ listing.get_latest_bid.date_creation|date:'D, M Y H:i:s'|title }}</li>
        <li>Category: {{ listing.category }}</li>
    </ul>

    {% if user.is_authenticated %}
        {% if listing.user.username == user.username %}
            <form name="create_station" method="post" action="{% url "auctions:open_close" listing.id %}">
                {% csrf_token %}
                <a href="{% url "auctions:edit" listing.id %}" class="btn btn-secondary">Edit</a>
                <input type="hidden" name="next" value="{{ request.path }}">
                {% if listing.active == False %}
                    <input type="submit" class="btn btn-success" value="Reopen Auction"/>
                {% else %}
                    <input type="submit" class="btn btn-danger" value="Close Auction"/>
                {% endif %}
            </form>
        {% endif %}
    {% endif %}

{% endblock %}